{% extends 'base.html' %}
{% load static %}
{% block title %}Estimativa de Custos - Tella{% endblock %}
{% block extra_css %}<link rel="stylesheet" href="{% static 'planejador.css' %}">{% endblock %}
{% block navbar %}
<nav class="navbar navbar-expand-lg sticky-top bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold text-uppercase d-flex align-items-center gap-2" href="{% url 'core:home' %}">
      <img src="{% static 'brand/logo.png' %}" alt="TELLA" class="tella-logo" />
      <span class="d-flex flex-column lh-1">
        <span class="tella-wordmark">TELLA</span>
        <small class="brand-sub">Turismo Nacional</small>
      </span>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="{% url 'core:home' %}">Início</a></li>
        <li class="nav-item"><a class="nav-link" href="{% url 'core:destinos' %}">Destinos</a></li>
        <li class="nav-item"><a class="nav-link active fw-bold" href="#">Estimativa de Custos</a></li>
      </ul>
      <div class="d-flex align-items-center ms-lg-3">
        {% if request.user.is_authenticated %}
          <span class="me-2 small text-muted">Olá, {{ request.user.first_name|default:request.user.username }}</span>
          <a href="{% url 'core:logout' %}" class="btn btn-outline-secondary btn-sm">Sair</a>
        {% else %}
          <a href="{% url 'core:login' %}" class="btn btn-outline-secondary btn-sm me-2">Entrar</a>
          <a href="{% url 'core:cadastro' %}" class="btn btn-danger btn-sm">Cadastrar</a>
        {% endif %}
      </div>
    </div>
  </div>
</nav>
<section class="subhero bg-light border-bottom py-3">
  <div class="container">
    <h1 class="h4 fw-bold mb-0">Planejador de Custos</h1>
    <p class="text-muted small mb-0">Veja e personalize estimativas para seu destino</p>
  </div>
</section>
{% endblock %}
{% block content %}
<div class="container my-5">
  <div class="text-center mb-5">
    <h2 class="fw-bold">Estimativa de Custos com IA</h2>
    <p class="text-muted">Descubra quanto custa visitar destinos turísticos em Angola</p>
  </div>
  
  {% if place %}
    <!-- Resultado da Estimativa -->
    <div class="row justify-content-center mb-4">
      <div class="col-lg-10">
        <div class="card border-0 shadow-lg">
          <div class="card-body p-4">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h4 class="fw-bold mb-2">{{ place.name }}</h4>
                <p class="text-muted mb-1">
                  <i class="bi bi-geo-alt-fill text-danger me-1"></i>
                  {{ place.address }}
                </p>
                <p class="text-muted mb-0">
                  <i class="bi bi-tag-fill text-success me-1"></i>
                  Categoria: <span class="badge bg-light text-dark">{{ place.categoria_destino|title }}</span>
                </p>
                {% if place.rating %}
                <p class="text-muted mb-0 mt-1">
                  <i class="bi bi-star-fill text-warning me-1"></i>
                  {{ place.rating }} ({{ place.userRatingCount }} avaliações)
                </p>
                {% endif %}
              </div>
              <div class="col-md-4 text-md-end">
                <div class="text-muted small">Custo Estimado</div>
                <div class="display-4 fw-bold text-danger">
                  {% if estimate is not None %}
                    Kz {{ estimate|floatformat:0 }}
                  {% else %}
                    <span class="text-muted">--</span>
                  {% endif %}
                </div>
                <div class="small text-muted">por pessoa</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Personalizar Estimativa -->
    <div class="row justify-content-center mb-4">
      <div class="col-lg-10">
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <h5 class="mb-3"><i class="bi bi-sliders me-2"></i>Personalizar Estimativa</h5>
            <form method="post" action="{% url 'core:estimate_place_cost' %}">
              {% csrf_token %}
              <input type="hidden" name="name" value="{{ place.name }}">
              <input type="hidden" name="address" value="{{ place.address }}">
              <input type="hidden" name="lat" value="{{ place.lat }}">
              <input type="hidden" name="lng" value="{{ place.lng }}">
              <input type="hidden" name="rating" value="{{ place.rating }}">
              <input type="hidden" name="userRatingCount" value="{{ place.userRatingCount }}">
              
              <div class="row">
                <div class="col-md-2 mb-3">
                  <label class="form-label">Tipo de Viajante</label>
                  <select name="tipo_viajante" class="form-select">
                    <option value="família" {% if place.tipo_viajante == 'família' %}selected{% endif %}>Família</option>
                    <option value="casal" {% if place.tipo_viajante == 'casal' %}selected{% endif %}>Casal</option>
                    <option value="solo" {% if place.tipo_viajante == 'solo' %}selected{% endif %}>Solo</option>
                    <option value="aventura" {% if place.tipo_viajante == 'aventura' %}selected{% endif %}>Aventura</option>
                    <option value="negócios" {% if place.tipo_viajante == 'negócios' %}selected{% endif %}>Negócios</option>
                  </select>
                </div>
                <div class="col-md-2 mb-3">
                  <label class="form-label">Duração (dias)</label>
                  <input type="number" name="duracao_dias" class="form-control" min="1" max="30" value="{{ place.duracao_dias|default:'3' }}">
                </div>
                <div class="col-md-2 mb-3">
                  <label class="form-label">Orçamento</label>
                  <select name="nivel_orcamento" class="form-select">
                    <option value="economico" {% if place.nivel_orcamento == 'economico' %}selected{% endif %}>Econômico</option>
                    <option value="medio" {% if place.nivel_orcamento == 'medio' or not place.nivel_orcamento %}selected{% endif %}>Médio</option>
                    <option value="luxo" {% if place.nivel_orcamento == 'luxo' %}selected{% endif %}>Luxo</option>
                  </select>
                </div>
                <div class="col-md-2 mb-3">
                  <label class="form-label">Transporte</label>
                  <select name="precisa_transporte" class="form-select">
                    <option value="sim" {% if place.precisa_transporte == 'sim' or not place.precisa_transporte %}selected{% endif %}>Preciso</option>
                    <option value="nao" {% if place.precisa_transporte == 'nao' %}selected{% endif %}>Tenho próprio</option>
                  </select>
                </div>
                <div class="col-md-2 mb-3">
                  <label class="form-label">Hospedagem</label>
                  <select name="precisa_hospedagem" class="form-select">
                    <option value="sim" {% if place.precisa_hospedagem == 'sim' or not place.precisa_hospedagem %}selected{% endif %}>Preciso</option>
                    <option value="nao" {% if place.precisa_hospedagem == 'nao' %}selected{% endif %}>Não vou me hospedar</option>
                  </select>
                </div>
                <div class="col-md-2 mb-3">
                  <label class="form-label">&nbsp;</label>
                  <button type="submit" class="btn btn-danger w-100">
                    <i class="bi bi-calculator"></i> Recalcular
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Ações -->
    <div class="text-center mb-5">
      <a href="{% url 'core:destinos' %}" class="btn btn-danger btn-lg me-3">
        <i class="bi bi-search"></i> Buscar Outro Destino
      </a>
      <button class="btn btn-outline-secondary btn-lg" onclick="window.location.reload()">
        <i class="bi bi-arrow-clockwise"></i> Recalcular
      </button>
    </div>
  {% else %}
    <!-- Estado Vazio -->
    <div class="row justify-content-center">
      <div class="col-lg-8 text-center">
        <div class="py-5">
          <i class="bi bi-calculator display-1 text-muted mb-4"></i>
          <h3 class="fw-bold mb-3">Nenhuma estimativa ainda</h3>
          <p class="text-muted mb-4">Selecione um destino para ver a estimativa de custos com nossa IA</p>
          
          <!-- Busca Rápida -->
          <div class="mb-4">
            <div class="input-group input-group-lg justify-content-center">
              <input type="text" id="quickSearch" class="form-control" style="max-width: 400px;" placeholder="Buscar destino (ex: Luanda, Benguela...)">
              <button class="btn btn-danger" type="button" id="quickSearchBtn">
                <i class="bi bi-search"></i>
              </button>
            </div>
            <div id="quickResults" class="mt-3"></div>
          </div>

          <div class="mb-4">
            <span class="text-muted">ou</span>
          </div>

          <a href="{% url 'core:destinos' %}" class="btn btn-danger btn-lg">
            <i class="bi bi-compass"></i> Explorar Destinos
          </a>
        </div>
      </div>
    </div>

    <!-- Como Funciona -->
    <div class="row justify-content-center mt-5">
      <div class="col-lg-10">
        <div class="card border-0 bg-light">
          <div class="card-body p-4">
            <h5 class="text-center mb-4">Como Funciona</h5>
            <div class="row text-center">
              <div class="col-md-3 mb-3">
                <div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                  <i class="bi bi-search text-danger fs-4"></i>
                </div>
                <h6 class="mt-2 mb-1">1. Busque</h6>
                <small class="text-muted">Encontre seu destino</small>
              </div>
              <div class="col-md-3 mb-3">
                <div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                  <i class="bi bi-mouse text-danger fs-4"></i>
                </div>
                <h6 class="mt-2 mb-1">2. Selecione</h6>
                <small class="text-muted">Clique no local desejado</small>
              </div>
              <div class="col-md-3 mb-3">
                <div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                  <i class="bi bi-cpu text-danger fs-4"></i>
                </div>
                <h6 class="mt-2 mb-1">3. IA Calcula</h6>
                <small class="text-muted">Algoritmo processa dados</small>
              </div>
              <div class="col-md-3 mb-3">
                <div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                  <i class="bi bi-check-circle text-danger fs-4"></i>
                </div>
                <h6 class="mt-2 mb-1">4. Resultado</h6>
                <small class="text-muted">Veja a estimativa</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const quickSearch = document.getElementById('quickSearch');
    const quickSearchBtn = document.getElementById('quickSearchBtn');
    const quickResults = document.getElementById('quickResults');

    // Busca rápida (estado vazio)
    if (quickSearch && quickSearchBtn) {
        function performQuickSearch() {
            const query = quickSearch.value.trim();
            if (!query) return;

            quickResults.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm text-danger" role="status"></div> Buscando...</div>';

            fetch(`/api/places/search/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.places && data.places.length > 0) {
                        let html = '<div class="row justify-content-center"><div class="col-md-8">';
                        data.places.slice(0, 3).forEach(place => {
                            html += `
                                <div class="card mb-2" style="cursor: pointer;" onclick="selectQuickPlace('${place.place_id}', '${place.name.replace(/'/g, "\\'")}', '${place.address.replace(/'/g, "\\'")}')">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-0">${place.name}</h6>
                                                <small class="text-muted">${place.address}</small>
                                            </div>
                                            <div class="text-end">
                                                <small class="text-muted">${place.rating || 'N/A'} ⭐</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div></div>';
                        quickResults.innerHTML = html;
                    } else {
                        quickResults.innerHTML = '<div class="alert alert-info">Nenhum resultado encontrado.</div>';
                    }
                })
                .catch(error => {
                    quickResults.innerHTML = '<div class="alert alert-danger">Erro na busca. Tente novamente.</div>';
                });
        }

        quickSearchBtn.addEventListener('click', performQuickSearch);
        quickSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performQuickSearch();
            }
        });
    }
});

function selectQuickPlace(placeId, name, address) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/api/places/estimate/';
    
    const csrfInput = document.querySelector('input[name=csrfmiddlewaretoken]');
    const csrfToken = csrfInput ? csrfInput.value : '';
    
    const fields = {
        'csrfmiddlewaretoken': csrfToken,
        'name': name,
        'address': address,
        'place_id': placeId
    };
    
    Object.keys(fields).forEach(key => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = fields[key];
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}
